local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SoundService = game:GetService("SoundService")
local MusicVisEvent = ReplicatedStorage:WaitForChild("MusicVisEvent")
local player = game.Players.LocalPlayer

local function debugPrint(message)
    print("[MusicVis Debug]", message)
end

local foundSounds = {}
local lastLoudnessUpdate = 0

task.spawn(function()
    debugPrint("Music Visualizer Client Started")
    while true do
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local foundAnySound = false
            local maxLoudness = 0
            local activeSoundId = ""
            for _, sound in ipairs(workspace:GetDescendants()) do
                if sound:IsA("Sound") and sound.IsPlaying then
                    foundAnySound = true
                    foundSounds[sound] = true
                    if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                        maxLoudness = sound.PlaybackLoudness
                        activeSoundId = sound.SoundId
                    end
                end
            end
            for _, sound in ipairs(SoundService:GetDescendants()) do
                if sound:IsA("Sound") and sound.IsPlaying then
                    foundAnySound = true
                    foundSounds[sound] = true
                    if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                        maxLoudness = sound.PlaybackLoudness
                        activeSoundId = sound.SoundId
                    end
                end
            end
            if char then
                for _, sound in ipairs(char:GetDescendants()) do
                    if sound:IsA("Sound") and sound.IsPlaying then
                        foundAnySound = true
                        foundSounds[sound] = true
                        if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                            maxLoudness = sound.PlaybackLoudness
                            activeSoundId = sound.SoundId
                        end
                    end
                end
            end
            maxLoudness = tonumber(maxLoudness) or 0
            MusicVisEvent:FireServer(activeSoundId, maxLoudness, char.HumanoidRootPart.Position)
            if tick() - lastLoudnessUpdate > 1 then
                lastLoudnessUpdate = tick()
            end
        end
        task.wait(0.02)
    end
end)

local function onDescendantAdded(descendant)
    if descendant:IsA("Sound") then
        task.wait(0.01)
    end
end

workspace.DescendantAdded:Connect(onDescendantAdded)
SoundService.DescendantAdded:Connect(onDescendantAdded)
