local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SoundService = game:GetService("SoundService")
local MusicVisEvent = ReplicatedStorage:WaitForChild("MusicVisEvent")
local player = game.Players.LocalPlayer

local function debugPrint(message)
    print("[MusicVis Debug]", message)
end

local foundSounds = {}
local lastLoudnessUpdate = 0

task.spawn(function()
    debugPrint("Music Visualizer Client Started")
    while true do
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local foundAnySound = false
            local maxLoudness = 0
            local activeSoundId = ""
            for _, sound in ipairs(workspace:GetDescendants()) do
                if sound:IsA("Sound") and sound.IsPlaying then
                    foundAnySound = true
                    foundSounds[sound] = true
                    if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                        maxLoudness = sound.PlaybackLoudness
                        activeSoundId = sound.SoundId
                    end
                    if tick() - lastLoudnessUpdate > 1 then
                        debugPrint(string.format("Workspace sound: %s, Loudness: %.2f, Playing: %s", 
                        sound.Name or "Unknown", sound.PlaybackLoudness or 0, tostring(sound.IsPlaying)))
                    end
                end
            end
            for _, sound in ipairs(SoundService:GetDescendants()) do
                if sound:IsA("Sound") and sound.IsPlaying then
                    foundAnySound = true
                    foundSounds[sound] = true
                    if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                        maxLoudness = sound.PlaybackLoudness
                        activeSoundId = sound.SoundId
                    end
                end
            end
            if char then
                for _, sound in ipairs(char:GetDescendants()) do
                    if sound:IsA("Sound") and sound.IsPlaying then
                        foundAnySound = true
                        foundSounds[sound] = true
                        if sound.PlaybackLoudness and sound.PlaybackLoudness > maxLoudness then
                            maxLoudness = sound.PlaybackLoudness
                            activeSoundId = sound.SoundId
                        end
                    end
                end
            end
            maxLoudness = tonumber(maxLoudness) or 0
            debugPrint(string.format("Firing MusicVisEvent: SoundId: %s, Loudness: %.2f, Position: %s", activeSoundId or "none", maxLoudness, tostring(char.HumanoidRootPart.Position)))
            MusicVisEvent:FireServer(player, activeSoundId, maxLoudness, char.HumanoidRootPart.Position)
            if tick() - lastLoudnessUpdate > 1 then
                if foundAnySound then
                    debugPrint(string.format("Sending loudness: %.2f from sound: %s", maxLoudness, activeSoundId))
                else
                    debugPrint("No sounds found - sending 0 loudness")
                end
                lastLoudnessUpdate = tick()
            end
        end
        task.wait(0.03)
    end
end)
local function onDescendantAdded(descendant)
    if descendant:IsA("Sound") then
        debugPrint("New sound detected: " .. (descendant.Name or "Unknown"))
    end
end

workspace.DescendantAdded:Connect(onDescendantAdded)
SoundService.DescendantAdded:Connect(onDescendantAdded)
