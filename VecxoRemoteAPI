local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local COMMAND_URL = "https://7d6fa7729c13.ngrok-free.app/latest-command"
local REGISTER_URL = "https://7d6fa7729c13.ngrok-free.app/register-server"

local banned = {}
local serverId = game.JobId
local serverLabel = "unknown"

-- Register this server
task.spawn(function()
	while true do
		local success, res = pcall(function()
			return HttpService:PostAsync(
				REGISTER_URL,
				HttpService:JSONEncode({ serverId = serverId }),
				Enum.HttpContentType.ApplicationJson
			)
		end)
		if success then
			local data = HttpService:JSONDecode(res)
			if data and data.label then
				serverLabel = data.label
			end
		end
		task.wait(10)
	end
end)

-- Fetch and run commands
local function runCommand(cmd)
	if not cmd or not cmd.text then return end

	local sender = cmd.sender or "Discord"
	local text = cmd.text:lower()

	print("[COMMAND RECEIVED] From:", sender, "| Command:", text)

	if text:sub(1, 2) == "m " then
		local msg = cmd.text:sub(3)
		for _, player in pairs(Players:GetPlayers()) do
			task.spawn(function()
				local gui = Instance.new("ScreenGui")
				gui.ResetOnSpawn = false
				gui.IgnoreGuiInset = true
				gui.Parent = player:FindFirstChildOfClass("PlayerGui")

				local lbl = Instance.new("TextLabel")
				lbl.Size = UDim2.new(1, 0, 0, 40)
				lbl.Position = UDim2.new(0, 0, 0, 0)
				lbl.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
				lbl.BackgroundTransparency = 0.4
				lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
				lbl.Font = Enum.Font.SourceSansBold
				lbl.TextScaled = true
				lbl.Text = `[Vecxo Remote API] {sender}: {msg}`
				lbl.Parent = gui

				task.delay(5, function() gui:Destroy() end)
			end)
		end
	end

	if text:sub(1, 2) == "h " then
		local msg = cmd.text:sub(3)
		for _, player in pairs(Players:GetPlayers()) do
			task.spawn(function()
				local gui = Instance.new("ScreenGui")
				gui.ResetOnSpawn = false
				gui.IgnoreGuiInset = true
				gui.Parent = player:FindFirstChildOfClass("PlayerGui")

				local lbl = Instance.new("TextLabel")
				lbl.Size = UDim2.new(1, 0, 0, 30)
				lbl.Position = UDim2.new(0, 0, -0.1, 0)
				lbl.BackgroundTransparency = 0.2
				lbl.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
				lbl.TextColor3 = Color3.new(1, 1, 1)
				lbl.Font = Enum.Font.Code
				lbl.TextScaled = true
				lbl.Text = `[Hint] {sender}: {msg}`
				lbl.Parent = gui

				task.delay(5, function() gui:Destroy() end)
			end)
		end
	end

	if text:sub(1, 5) == "kick " then
		local target = text:sub(6):lower()
		for _, p in pairs(Players:GetPlayers()) do
			if p.Name:lower():sub(1, #target) == target then
				p:Kick(`[Vecxo Remote API] Kicked by {sender}`)
				break
			end
		end
	end

	if text:sub(1, 4) == "ban " then
		local target = text:sub(5):lower()
		for _, p in pairs(Players:GetPlayers()) do
			if p.Name:lower():sub(1, #target) == target then
				table.insert(banned, p.Name)
				p:Kick(`[Vecxo Remote API] Banned by {sender}`)
				break
			end
		end
	end

	if text == "shutdown" then
		for _, p in pairs(Players:GetPlayers()) do
			p:Kick(`[Vecxo Remote API] Shutdown by {sender}`)
		end
		game:Shutdown()
	end
end

Players.PlayerAdded:Connect(function(player)
	if table.find(banned, player.Name) then
		player:Kick("[Vecxo Remote API] You were banned.")
	end
end)

pcall(function()
	local h = Instance.new('Hint', workspace)
	h.Text = '[Vecxo Remote API] Connected as ' .. serverLabel
	task.wait(3)
	h:Destroy()
end)

while true do
	task.wait(1.5)

	local success, response = pcall(function()
		local url = COMMAND_URL .. "?serverId=" .. HttpService:UrlEncode(serverId)
		return HttpService:GetAsync(url)
	end)

	if success then
		local data = HttpService:JSONDecode(response)
		if data and data.command then
			runCommand(data.command)
		end
	else
		warn("Command fetch failed:", response)
	end
end
