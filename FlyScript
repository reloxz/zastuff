local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

local uis = game:GetService("UserInputService")
local rs = game:GetService("RunService")

local flying = false
local speed = 2
local maxSpeed = 3.5
local smoothness = 0.15
local bv, bg
local chatFocused = false

game:GetService("TextChatService").TextChannels.RBXGeneral.ChannelJoined:Connect(function(channel)
	channel:GetPropertyChangedSignal("TypingStatus"):Connect(function()
		chatFocused = channel.TypingStatus == Enum.ChatTypingStatus.Typing
	end)
end)

local function startFly()
	if flying then return end
	flying = true
	
	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	bv.Velocity = Vector3.zero
	bv.Parent = root

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	bg.P = 9e4
	bg.CFrame = root.CFrame
	bg.Parent = root
	
	humanoid.PlatformStand = true

	local moveDir = Vector3.zero
	
	local conn
	conn = rs.RenderStepped:Connect(function(dt)
		if not flying or not character or not root then
			conn:Disconnect()
			return
		end
		
		local camCF = workspace.CurrentCamera.CFrame
		local direction = Vector3.zero
		
		if uis:IsKeyDown(Enum.KeyCode.W) then
			direction += camCF.LookVector
		end
		if uis:IsKeyDown(Enum.KeyCode.S) then
			direction -= camCF.LookVector
		end
		if uis:IsKeyDown(Enum.KeyCode.A) then
			direction -= camCF.RightVector
		end
		if uis:IsKeyDown(Enum.KeyCode.D) then
			direction += camCF.RightVector
		end
		if uis:IsKeyDown(Enum.KeyCode.Space) then
			direction += Vector3.new(0, 1, 0)
		end
		if uis:IsKeyDown(Enum.KeyCode.LeftShift) then
			direction -= Vector3.new(0, 1, 0)
		end

		if direction.Magnitude > 0 then
			moveDir = moveDir:Lerp(direction.Unit * (speed * 50), smoothness)
		else
			moveDir = moveDir:Lerp(Vector3.zero, smoothness)
		end

		bv.Velocity = moveDir
		bg.CFrame = camCF
	end)
end

local function stopFly()
	if not flying then return end
	flying = false
	if bv then bv:Destroy() end
	if bg then bg:Destroy() end
	if humanoid then humanoid.PlatformStand = false end
end

uis.InputBegan:Connect(function(input, processed)
	if processed or chatFocused then return end
	if input.KeyCode == Enum.KeyCode.F then
		if flying then
			stopFly()
		else
			startFly()
		end
	end
end)
